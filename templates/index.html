<!DOCTYPE html>
<html>
<head>
    <title>Chess AI</title>
    <link rel="stylesheet" href="https://chessboardjs.com/css/chessboard-1.0.0.min.css">
    <style>
        /* CSS styles (same as before) */
        body {
            font-family: sans-serif;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .container {
            background-color: #fff;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0px 5px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        #board {
            width: 400px;
            margin: 0 auto;
            border: 2px solid #ccc;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            margin: 10px 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #367c39;
        }

        #trainingStatus {
            margin-top: 20px;
            font-size: 16px;
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Chess AI</h1>
        <div id="board" style="width: 400px"></div> <button id="newGameBtn">New Game</button>
        <button id="trainBtn">Train AI</button>
        <button id="aiMoveBtn">Get AI Move</button>
        <p id="trainingStatus"></p>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://chessboardjs.com/js/chessboard-1.0.0.min.js"></script>
    <script>
        var board = null;
        var game = new Chess();
        var $trainingStatus = $('#trainingStatus');

        function onDragStart (source, piece, position, orientation) {
            // do not pick up pieces if the game is over
            if (game.game_over()) return false;

            // only pick up pieces for the side to move
            if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                return false;
            }
        }

        function onDrop (source, target) {
            // see if the move is legal
            var move = game.move({
                from: source,
                to: target,
                promotion: 'q' // NOTE: always promote to a queen for example simplicity
            });

            // illegal move
            if (move === null) return 'snapback';

            updateStatus();

            // Send move to server
            jQuery.ajax({
                url: "/move",
                type: "POST",
                data: JSON.stringify({move: move.from + move.to}),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function(data){
                    // Update board
                    board.position(data.board);
                }
            });
        }

        // update the board position after the piece snap
        // for castling, en passant, pawn promotion
        function onSnapEnd () {
            board.position(game.fen());
        }

        function updateStatus () {
            var status = '';

            var moveColor = 'White';
            if (game.turn() === 'b') {
                moveColor = 'Black';
            }

            // checkmate?
            if (game.in_checkmate()) {
                status = 'Game over, ' + moveColor + ' is in checkmate.';
            }

            // draw?
            else if (game.in_draw()) {
                status = 'Game over, drawn position';
            }

            // game still on
            else {
                status = moveColor + ' to move';

                // check?
                if (game.in_check()) {
                    status += ', ' + moveColor + ' is in check';
                }
            }

            $trainingStatus.html(status);
        }

        // Changed the way the board is initialized
        board = Chessboard('board', {
            draggable: true,
            position: 'start',
            onDragStart: onDragStart,
            onDrop: onDrop,
            onSnapEnd: onSnapEnd,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });

        updateStatus();

        // --- Button Events ---

        $('#newGameBtn').on('click', function() {
            $.get('/new_game', function(data) {
                game.load(data.board);
                board.position(data.board);
                updateStatus();
            });
        });

        $('#trainBtn').on('click', function() {
            $.ajax({
                url: '/train',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({num_games: 10, save_path: "chess_ai_model.h5"}), // Send data
                success: function(response) {
                    $trainingStatus.html(response.message);
                    // Poll for training status
                    var pollTrainingStatus = setInterval(function() {
                        $.get('/training_status', function(data) {
                            $trainingStatus.html(data.status);
                            if (data.status === "Training not running.") {
                                clearInterval(pollTrainingStatus);
                            }
                        });
                    }, 5000); // Check every 5 seconds
                }
            });
        });

        $('#aiMoveBtn').on('click', function() {
            $.get('/ai_move', function(data) {
                if (!data.error) {
                    game.move(data.ai_move);
                    board.position(game.fen());
                    updateStatus();
                } else {
                    console.log(data.error);
                }
            });
        });

    </script>
</body>
</html>